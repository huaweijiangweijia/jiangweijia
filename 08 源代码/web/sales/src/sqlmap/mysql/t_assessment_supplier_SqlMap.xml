<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="t_assessment_supplier">
  <resultMap class="com.tl.resource.dao.pojo.TSupplierAssessment" id="ibatorgenerated_BaseResultMap">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    <result column="id" jdbcType="VARCHAR" property="id" />
    <result column="supplier_id" jdbcType="VARCHAR" property="supplierId" />
    <result column="emp_number" jdbcType="INTEGER" property="empNumber" />
    <result column="product" jdbcType="VARCHAR" property="product" />
    <result column="competitive" jdbcType="VARCHAR" property="competitive" />
    <result column="annual_sale" jdbcType="DECIMAL" property="annualSale" />
    <result column="brand_power" jdbcType="VARCHAR" property="brandPower" />
    <result column="market_share" jdbcType="DECIMAL" property="marketShare" />
    <result column="qualfied_rate" jdbcType="DECIMAL" property="qualfiedRate" />
    <result column="return_rate" jdbcType="DECIMAL" property="returnRate" />
    <result column="delivery_punctuality_rate" jdbcType="DECIMAL" property="deliveryPunctualityRate" />
    <result column="delivery_good_rate" jdbcType="DECIMAL" property="deliveryGoodRate" />
    <result column="areas" jdbcType="VARCHAR" property="areas" />
    <result column="sole" jdbcType="VARCHAR" property="sole" />
    <result column="report" jdbcType="VARCHAR" property="report" />
    <result column="support" jdbcType="VARCHAR" property="support" />
    <result column="quality" jdbcType="VARCHAR" property="quality" />
    <result column="amount" jdbcType="DECIMAL" property="amount" />
    <result column="pay_period" jdbcType="INTEGER" property="payPeriod" />
    <result column="score" jdbcType="INTEGER" property="score" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="create_user_id" jdbcType="VARCHAR" property="createUserId" />
    <result column="last_edit_time" jdbcType="TIMESTAMP" property="lastEditTime" />
    <result column="last_user_id" jdbcType="VARCHAR" property="lastUserId" />
    <result column="create_user_name" jdbcType="VARCHAR" property="createUserName" />
  	<result column="last_user_name" jdbcType="VARCHAR" property="lastUserName" />
  </resultMap>
  <resultMap class="com.tl.resource.business.dto.SupplierAssessmentDto" id="assessmentALl" extends="ibatorgenerated_BaseResultMap">
  	<result column="price_difference" jdbcType="DECIMAL" property="priceDifference" />
  	<result column="ratio" jdbcType="DECIMAL" property="ratio" />
  	<result column="supplier_name" jdbcType="VARCHAR" property="supplierName" />
  </resultMap>
 
  <select id="ibatorgenerated_selectByPrimaryKey" parameterClass="com.tl.resource.dao.pojo.TCompanyInfor" resultMap="ibatorgenerated_BaseResultMap">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    select id, company_name, company_code, fax, phone, bank, account_number, company_address,
      contact_person, postcode ,reg_address,tax_code
    from t_company_infor 
    where id = #id:VARCHAR#
  </select>
  
   <select id="getAssessmentList" parameterClass="java.util.Map" resultMap="assessmentALl">
	
	SELECT tas.*,b.price_difference,b.supplier_name,IFNULL(tas.amount/(IFNULL(c.order_money,0)),0) AS ratio  FROM t_assessment_supplier tas	 LEFT JOIN (
		SELECT tt.supplier_id,tt.supplier_name,od.id order_id,od.tools_id,ci.id contract_id,SUM(cpd.net_price-od.price) AS price_difference FROM t_order_detail od INNER JOIN(
				SELECT * FROM t_order_infor oi  WHERE oi.contract_code IS NOT NULL 
				) tt ON od.stock_order_infor_id = tt.id  
				LEFT JOIN t_contract_infor ci ON tt.contract_code = ci.contract_code AND ci.status IN (4,5) 
		LEFT JOIN t_contract_product_detail cpd ON cpd.contract_infor_id = ci.id  AND cpd.tools_id = od.tools_id  GROUP BY tt.supplier_id
		) b ON tas.supplier_id = b.supplier_id  
	
	LEFT JOIN (
		SELECT SUM(final_money) AS order_money,supplier_id FROM t_order_infor  WHERE supplier_id !="" AND (YEAR(edit_date)=YEAR(NOW()) AND  MONTH(edit_date)=MONTH(NOW()))  GROUP BY supplier_id
	) c ON tas.supplier_id = c.supplier_id
		
   	<dynamic prepend="where">
	   <isNotEmpty prepend="and" property="supplierId">
			tas.supplier_id = '$supplierId$'
		</isNotEmpty>
   	 </dynamic>
		
      <isNotEmpty property="sort" >
        <![CDATA[
          order by $sort$ $dir$
        ]]>
      </isNotEmpty>
    <![CDATA[
        limit #start#, #limit# 
    ]]>
  </select>
  <select id="getAssessmentListCount" parameterClass="java.util.Map" resultClass="java.lang.Integer">
   	 select count(*) from t_assessment_supplier t
   	<dynamic prepend="where">
	   <isNotEmpty prepend="and" property="supplierId">
			t.supplier_id = '$supplierId$'
		</isNotEmpty>
   	 </dynamic>
  </select>
  
  
  
  
  <delete id="deleteByPrimaryKey" parameterClass="com.tl.resource.dao.pojo.TSupplierAssessment">
    delete from t_assessment_supplier
    where id = #id:VARCHAR#
  </delete>
  
  
 <insert id="insert" parameterClass="com.tl.resource.dao.pojo.TSupplierAssessment">
    INSERT INTO t_assessment_supplier (id, supplier_id, emp_number,annual_sale, brand_power, 
    market_share, competitive, product, qualfied_rate, return_rate, delivery_punctuality_rate, 
    delivery_good_rate, areas, sole, report, support, quality, amount, pay_period, score, create_time, create_user_id, create_user_name,
    last_edit_time, last_user_id ,last_user_name)
    values (#id:VARCHAR#, #supplierId:VARCHAR#, #empNumber:INTEGER#, #annualSale:DECIMAL#,#brandPower:VARCHAR#,
      #marketShare:VARCHAR#, #competitive:VARCHAR#, #product:DECIMAL#, #qualfiedRate:DECIMAL#,
      #returnRate:DECIMAL#, #deliveryPunctualityRate:DECIMAL#, #deliveryGoodRate:DECIMAL#, #areas:VARCHAR#,
      #sole:VARCHAR#, #report:DECIMAL#, #support:VARCHAR#,
      #quality:VARCHAR#, #amount:DECIMAL#, #payPeriod:INTEGER#,
      #score:INTEGER#, #createTime:TIMESTAMP#, #createUserId:VARCHAR#, #createUserName:VARCHAR#,#lastEditTime:TIMESTAMP#,
      #lastUserId:VARCHAR#,#lastUserName:VARCHAR#)
  </insert>
  <update id="updateByPrimaryKey" parameterClass="com.tl.resource.dao.pojo.TSupplierAssessment">
    update t_assessment_supplier
    set supplier_id = #supplierId:VARCHAR#,
      emp_number = #empNumber:INTEGER#,
      annual_sale = #annualSale:DECIMAL#,
      brand_power = #brandPower:VARCHAR#,
      market_share = #marketShare:DECIMAL#,
      competitive = #competitive:VARCHAR#,
      product = #product:VARCHAR#,
      qualfied_rate = #qualfiedRate:DECIMAL#,
      return_rate = #returnRate:DECIMAL#,
      delivery_punctuality_rate = #deliveryPunctualityRate:DECIMAL#,
      delivery_good_rate = #deliveryGoodRate:DECIMAL#,
      areas = #areas:VARCHAR#,
      sole = #sole:VARCHAR#,
      report = #report:VARCHAR#,
      support = #support:VARCHAR#,
      quality = #quality:VARCHAR#,
      amount = #amount:DECIMAL#,
      pay_period = #payPeriod:INTEGER#,
      score = #score:INTEGER#,
      last_edit_time = #lastEditTime:TIMESTIMP#,
      last_user_name = #lastUserName:VARCHAR#,
      last_user_id = #lastUserId:VARCHAR#
    where id = #id:VARCHAR#
  </update>
</sqlMap>