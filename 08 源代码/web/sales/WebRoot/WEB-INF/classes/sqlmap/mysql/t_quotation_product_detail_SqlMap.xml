<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="t_quotation_product_detail">

<typeAlias alias="orderDetailDto" type="com.tl.resource.business.dto.OrderDetialsDto"/>

  <resultMap class="com.tl.resource.dao.pojo.TQuotationProductDetail" id="ibatorgenerated_BaseResultMap">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    <result column="id" jdbcType="VARCHAR" property="id" />
    <result column="quotation_project_sort_id" jdbcType="VARCHAR" property="quotationProjectSortId" />
    <result column="quotation_infor_id" jdbcType="VARCHAR" property="quotationInforId" />
    <result column="tools_id" jdbcType="VARCHAR" property="toolsId" />
    <result column="parent_tools_id" jdbcType="VARCHAR" property="parentToolsId" />
    <result column="leaf" jdbcType="INTEGER" property="leaf" />
    <result column="project_code" jdbcType="VARCHAR" property="projectCode" />
    <result column="serial_number" jdbcType="DECIMAL" property="serialNumber" />
    <result column="product_brand" jdbcType="VARCHAR" property="productBrand" />
    <result column="product_code" jdbcType="VARCHAR" property="productCode" />
    <result column="brand_code" jdbcType="VARCHAR" property="brandCode" />
    <result column="product_name" jdbcType="VARCHAR" property="productName" />
    <result column="single_set_assembly_amount" jdbcType="DECIMAL" property="singleSetAssemblyAmount" />
    <result column="single_set_stock_amount" jdbcType="DECIMAL" property="singleSetStockAmount" />
    <result column="amount" jdbcType="DECIMAL" property="amount" />
    <result column="price" jdbcType="DECIMAL" property="price" />
    <result column="product_unit" jdbcType="VARCHAR" property="productUnit" />
    <result column="rebate" jdbcType="DECIMAL" property="rebate" />
    <result column="net_price" jdbcType="DECIMAL" property="netPrice" />
    <result column="money" jdbcType="DECIMAL" property="money" />
    <result column="tax_net_price" jdbcType="DECIMAL" property="taxNetPrice" />
    <result column="tax_money" jdbcType="DECIMAL" property="taxMoney" />
    <result column="price_change" jdbcType="DECIMAL" property="priceChange" />
    <result column="delivery_date" jdbcType="VARCHAR" property="deliveryDate" />
    <result column="workshop" jdbcType="VARCHAR" property="workshop" />
    <result column="process_code" jdbcType="VARCHAR" property="processCode" />
    <result column="report_code" jdbcType="VARCHAR" property="reportCode" />
    <result column="tool_code" jdbcType="VARCHAR" property="toolCode" />
    <result column="tool_description" jdbcType="VARCHAR" property="toolDescription" />
    <result column="memo" jdbcType="VARCHAR" property="memo" />
  </resultMap>
  
   <!-- 订单详细的Dto -->
  <resultMap class="com.tl.resource.business.dto.OrderDetialsDto" id="orderDetailResultMap">
    <result column="contract_product_detail_id" jdbcType="VARCHAR" property="contractProductDetailId" />
    <result column="brand_code" jdbcType="VARCHAR" property="brandCode" />
    <result column="tools_id" jdbcType="VARCHAR" property="toolsId" />
    <result column="parent_tools_id" jdbcType="VARCHAR" property="parentToolsId" />
    <result column="leaf" jdbcType="INTEGER" property="leaf" />
    <result column="product_name" jdbcType="VARCHAR" property="productName" />
    <result column="contract_amount" jdbcType="DECIMAL" property="contractAmount" />
    <result column="order_amount" jdbcType="DECIMAL" property="orderAmount" />
    <result column="remain_amount" jdbcType="DECIMAL" property="remainAmount" />
    <result column="product_unit" jdbcType="VARCHAR" property="productUnit" />
    <result column="price" jdbcType="DECIMAL" property="price" />
    <result column="product_money" jdbcType="DECIMAL" property="productMoney" />
    <result column="product_brand" jdbcType="VARCHAR" property="productBrand" />
    <result column="product_code" jdbcType="VARCHAR" property="productCode" />
    <result column="serial_number" jdbcType="DECIMAL" property="serialNumber" />
    <result column="delivery_date" jdbcType="VARCHAR" property="deliveryDate" />
   	<result column="file_count" jdbcType="INTEGER" property="fileCount" />
   	<result column="pro_sort_name" jdbcType="VARCHAR" property="proSortName" />
   	<result column="project_code" jdbcType="VARCHAR" property="projectCode" />
  </resultMap>
  
  <resultMap id="resultMap" class="com.tl.resource.dao.pojo.TQuotationProductDetail" extends="ibatorgenerated_BaseResultMap">
    <result property="children" column="id" select="t_quotation_product_detail.getProToolsByParId"/>
  </resultMap>
  
  <resultMap id="result" class="com.tl.resource.business.dto.QuotationDetailForOrderDto" extends="ibatorgenerated_BaseResultMap">
        <result column="order_amount" jdbcType="DECIMAL" property="orderAmount" />
        <result column="remain_amount" jdbcType="DECIMAL" property="remainAmount" /> 
        <result column="pro_sort_name" jdbcType="VARCHAR" property="proSortName" />
  </resultMap>
  
  <resultMap id="resultChild" class="com.tl.resource.business.dto.QuotationDetailForOrderDto" extends="ibatorgenerated_BaseResultMap">
  	<result column="order_amount" jdbcType="DECIMAL" property="orderAmount" />
    <result column="remain_amount" jdbcType="DECIMAL" property="remainAmount" /> 
    <result column="pro_sort_name" jdbcType="VARCHAR" property="proSortName" />
    <result column="file_count" jdbcType="INTEGER" property="fileCount" />
  	<result property="children" column="tools_id" select="t_quotation_product_detail.getChildrenFromToolsInfor"/>
  </resultMap>
  
  <resultMap id="childrenPartResult" class="orderDetailDto" extends="orderDetailResultMap">
     <result column="file_count" jdbcType="INTEGER" property="fileCount" />
    <result property="children" column="tools_id" select="t_quotation_product_detail.getScheduleOrderChildren"/>
  </resultMap>
  
  
  <sql id="ibatorgenerated_Example_Where_Clause">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    <iterate conjunction="or" prepend="where" property="oredCriteria" removeFirstPrepend="iterate">
      <isEqual compareValue="true" property="oredCriteria[].valid">
        (
        <iterate conjunction="and" prepend="and" property="oredCriteria[].criteriaWithoutValue">
          $oredCriteria[].criteriaWithoutValue[]$
        </iterate>
        <iterate conjunction="and" prepend="and" property="oredCriteria[].criteriaWithSingleValue">
          $oredCriteria[].criteriaWithSingleValue[].condition$
            #oredCriteria[].criteriaWithSingleValue[].value#
        </iterate>
        <iterate conjunction="and" prepend="and" property="oredCriteria[].criteriaWithListValue">
          $oredCriteria[].criteriaWithListValue[].condition$
          <iterate close=")" conjunction="," open="(" property="oredCriteria[].criteriaWithListValue[].values">
            #oredCriteria[].criteriaWithListValue[].values[]#
          </iterate>
        </iterate>
        <iterate conjunction="and" prepend="and" property="oredCriteria[].criteriaWithBetweenValue">
          $oredCriteria[].criteriaWithBetweenValue[].condition$
          #oredCriteria[].criteriaWithBetweenValue[].values[0]# and
          #oredCriteria[].criteriaWithBetweenValue[].values[1]#
        </iterate>
        )
      </isEqual>
    </iterate>
  </sql>
  
  <!-- 从工具信息中查找子节点 -->
  <select id="getChildrenFromToolsInfor" parameterClass="java.lang.String" resultClass="java.util.List"  resultMap="resultChild">
 select id,'' as quotation_project_sort_id,'' as quotation_infor_id,id as tools_id,
		parent_id as parent_tools_id, leaf,
      0 as project_code,0 as serial_number, product_brand, product_code, brand_code, product_name,
      0 as single_set_assembly_amount,0 as single_set_stock_amount, amount, product_unit,0 as price,
		0 as rebate,0 as net_price,0 as money,0 as tax_net_price,0 as tax_money,0 as price_change,'' as delivery_date,'' as workshop,
     '' as process_code,'' as report_code,'' as tool_code,'' as tool_description, memo,0 order_amount,0 file_count,
		0 remain_amount,'' pro_sort_name
	from t_product_tools_infor
 	where parent_id =  #value#
  </select>
  
    <!-- 从工具信息中查找子节点(预定加工订单) -->
  <select id="getScheduleOrderChildren" parameterClass="java.lang.String" resultClass="java.util.List"  resultMap="childrenPartResult">
 select 0 as price,'' as contract_product_detail_id,
	brand_code,id as tools_id,parent_id as parent_tools_id,leaf,product_name,amount as contract_amount,  
	0 as order_amount,0 as remain_amount,product_unit,0 as product_money,product_brand,product_code,
	0 as serial_number,'' as delivery_date,0 as file_count,'' as pro_sort_name,'' as contract_project_sort_id,0 as file_count
		from t_product_tools_infor
 	where parent_id = #value#
  </select>
  
  <!-- 根据报价单删除报价单产品(ftl) -->
  <delete id="deleteByQuoId" parameterClass="String">
    delete from t_quotation_product_detail
    where quotation_infor_id = #value:VARCHAR#
  </delete>
  
  <!-- 获取报价单详细信息 -->
  <select id="getQuoDetail" parameterClass="java.lang.String" resultClass="com.tl.resource.dao.pojo.TQuotationProductDetail" resultMap="resultMap">
    <![CDATA[
      select id, quotation_project_sort_id, quotation_infor_id, tools_id, parent_tools_id, 
      leaf,
      project_code, serial_number, product_brand, product_code, brand_code, product_name,
      single_set_assembly_amount, single_set_stock_amount, amount, price, product_unit, rebate,
      net_price, money, tax_net_price, tax_money, price_change, delivery_date, workshop,
      process_code, report_code, tool_code, tool_description, memo
      from t_quotation_product_detail t where t.quotation_infor_id = #value# and t.parent_tools_id='root'
    ]]>
  </select>

  <!-- 查询产品列表信息 -->
  <select id="getProductList" parameterClass="java.util.Map" resultClass="com.tl.resource.dao.pojo.TQuotationProductDetail" resultMap="resultMap">
    <![CDATA[
      select id, quotation_project_sort_id, quotation_infor_id, tools_id, parent_tools_id, 
      case 
      when leaf = 1 then
      'true'
      else
      'false'
      end as leaf,
      project_code, serial_number, product_brand, product_code, brand_code, product_name,
      single_set_assembly_amount, single_set_stock_amount, amount, price, product_unit, rebate,
      net_price, money, tax_net_price, tax_money, price_change, delivery_date, workshop,
      process_code, report_code, tool_code, tool_description, memo
      from t_quotation_product_detail t where t.quotation_project_sort_id = #quotation_project_sort_id# and t.parent_tools_id='root'
    ]]>
    
    
  </select>
  
  <!-- 获取子节点 -->
  <select id="getProToolsByParId" parameterClass="java.lang.String" resultClass="com.tl.resource.dao.pojo.TQuotationProductDetail" resultMap="resultMap">
      <![CDATA[
        select id, quotation_project_sort_id, quotation_infor_id, tools_id, parent_tools_id, leaf,
        project_code, serial_number, product_brand, product_code, brand_code, product_name,
        single_set_assembly_amount, single_set_stock_amount, amount, price, product_unit, rebate,
        net_price, money, tax_net_price, tax_money, price_change, delivery_date, workshop,
        process_code, report_code, tool_code, tool_description, memo
        from t_quotation_product_detail t where t.parent_tools_id=#value#
      ]]>
  </select>
  
  <!-- 获取子节点 -->
  <select id="getChildren" parameterClass="java.lang.String" resultClass="com.tl.resource.business.dto.QuotationDetailForOrderDto" resultMap="resultChild">
      <![CDATA[
        select id, quotation_project_sort_id, quotation_infor_id, tools_id, parent_tools_id, leaf,
        project_code, serial_number, product_brand, product_code, brand_code, product_name,
        single_set_assembly_amount, single_set_stock_amount, amount, price, product_unit, rebate,
        net_price, money, tax_net_price, tax_money, price_change, delivery_date, workshop,
        process_code, report_code, tool_code, tool_description, memo,
        	0 remain_amount,0 order_amount,'' pro_sort_name,
		(select ifnull(count(*),0) from t_accessories where business_id = t.tools_id and business_type = 1) as file_count
        from t_quotation_product_detail t where t.parent_tools_id=#value#
      ]]>
  </select>
  
  
  <!-- 获取价格有变动的报价单详细信息 --> 
  <select id="getQuoDetailByPriChange" parameterClass="java.util.Map" resultClass="com.tl.resource.dao.pojo.TQuotationProductDetail" resultMap="resultMap">
    <![CDATA[
      select id, quotation_project_sort_id, quotation_infor_id, tools_id, parent_tools_id, 
      leaf,
      project_code, serial_number, product_brand, product_code, brand_code, product_name,
      single_set_assembly_amount, single_set_stock_amount, amount, price, product_unit, rebate,
      net_price, money, tax_net_price, tax_money, price_change, delivery_date, workshop,
      process_code, report_code, tool_code, tool_description, memo
      from t_quotation_product_detail t where t.quotation_infor_id = #quoInfoId# and t.parent_tools_id='root' and (t.price_change='1'  or t.price_change='2' or t.price_change='3')
    ]]>
  </select>
  
  <select id="ibatorgenerated_selectByExample" parameterClass="com.tl.resource.dao.pojo.TQuotationProductDetailExample" resultMap="ibatorgenerated_BaseResultMap">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    select id, quotation_project_sort_id, quotation_infor_id, tools_id, parent_tools_id, leaf,
      project_code, serial_number, product_brand, product_code, brand_code, product_name,
      single_set_assembly_amount, single_set_stock_amount, amount, price, product_unit, rebate,
      net_price, money, tax_net_price, tax_money, price_change, delivery_date, workshop,
      process_code, report_code, tool_code, tool_description, memo
    from t_quotation_product_detail
    <isParameterPresent>
      <include refid="t_quotation_product_detail.ibatorgenerated_Example_Where_Clause" />
      <isNotNull property="orderByClause">
        order by $orderByClause$
      </isNotNull>
    </isParameterPresent>
  </select>
  <select id="ibatorgenerated_selectByPrimaryKey" parameterClass="com.tl.resource.dao.pojo.TQuotationProductDetail" resultMap="ibatorgenerated_BaseResultMap">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    select id, quotation_project_sort_id, quotation_infor_id, tools_id, parent_tools_id, leaf,
      project_code, serial_number, product_brand, product_code, brand_code, product_name,
      single_set_assembly_amount, single_set_stock_amount, amount, price, product_unit, rebate,
      net_price, money, tax_net_price, tax_money, price_change, delivery_date, workshop,
      process_code, report_code, tool_code, tool_description, memo
    from t_quotation_product_detail
    where id = #id:VARCHAR#
  </select>
  <delete id="ibatorgenerated_deleteByPrimaryKey" parameterClass="com.tl.resource.dao.pojo.TQuotationProductDetail">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    delete from t_quotation_product_detail
    where id = #id:VARCHAR#
  </delete>
  <delete id="ibatorgenerated_deleteByExample" parameterClass="com.tl.resource.dao.pojo.TQuotationProductDetailExample">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    delete from t_quotation_product_detail
    <include refid="t_quotation_product_detail.ibatorgenerated_Example_Where_Clause" />
  </delete>
  
  <!-- 删除产品信息根据报价单ID -->
  <delete id="deleteProByQuoID" parameterClass="java.lang.String">
    delete from t_quotation_product_detail where quotation_infor_id = #VARCHAR#
  </delete>
  
   <!-- 删除产品信息根据工序ID -->
  <delete id="deleteProByWorkID" parameterClass="java.lang.String">
    delete from t_quotation_product_detail where quotation_project_sort_id = #VARCHAR#
  </delete>
  
  <insert id="ibatorgenerated_insert" parameterClass="com.tl.resource.dao.pojo.TQuotationProductDetail">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    insert into t_quotation_product_detail (id, quotation_project_sort_id, quotation_infor_id,
      tools_id, parent_tools_id, leaf, project_code, serial_number, product_brand, product_code,
      brand_code, product_name, single_set_assembly_amount, single_set_stock_amount, amount, price,
      product_unit, rebate, net_price, money, tax_net_price, tax_money, price_change, delivery_date,
      workshop, process_code, report_code, tool_code, tool_description, memo)
    values (#id:VARCHAR#, #quotationProjectSortId:VARCHAR#, #quotationInforId:VARCHAR#,
      #toolsId:VARCHAR#, #parentToolsId:VARCHAR#, #leaf:INTEGER#, #projectCode:VARCHAR#,
      #serialNumber:DECIMAL#, #productBrand:VARCHAR#, #productCode:VARCHAR#, #brandCode:VARCHAR#,
      #productName:VARCHAR#, #singleSetAssemblyAmount:DECIMAL#, #singleSetStockAmount:DECIMAL#,
      #amount:DECIMAL#, #price:DECIMAL#, #productUnit:VARCHAR#, #rebate:DECIMAL#,
      #netPrice:DECIMAL#, #money:DECIMAL#, #taxNetPrice:DECIMAL#, #taxMoney:DECIMAL#,
      #priceChange:DECIMAL#, #deliveryDate:VARCHAR#, #workshop:VARCHAR#, #processCode:VARCHAR#,
      #reportCode:VARCHAR#, #toolCode:VARCHAR#, #toolDescription:VARCHAR#, #memo:VARCHAR#)
  </insert>
  <insert id="ibatorgenerated_insertSelective" parameterClass="com.tl.resource.dao.pojo.TQuotationProductDetail">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    insert into t_quotation_product_detail
    <dynamic prepend="(">
      <isNotNull prepend="," property="id">
        id
      </isNotNull>
      <isNotNull prepend="," property="quotationProjectSortId">
        quotation_project_sort_id
      </isNotNull>
      <isNotNull prepend="," property="quotationInforId">
        quotation_infor_id
      </isNotNull>
      <isNotNull prepend="," property="toolsId">
        tools_id
      </isNotNull>
      <isNotNull prepend="," property="parentToolsId">
        parent_tools_id
      </isNotNull>
      <isNotNull prepend="," property="leaf">
        leaf
      </isNotNull>
      <isNotNull prepend="," property="projectCode">
        project_code
      </isNotNull>
      <isNotNull prepend="," property="serialNumber">
        serial_number
      </isNotNull>
      <isNotNull prepend="," property="productBrand">
        product_brand
      </isNotNull>
      <isNotNull prepend="," property="productCode">
        product_code
      </isNotNull>
      <isNotNull prepend="," property="brandCode">
        brand_code
      </isNotNull>
      <isNotNull prepend="," property="productName">
        product_name
      </isNotNull>
      <isNotNull prepend="," property="singleSetAssemblyAmount">
        single_set_assembly_amount
      </isNotNull>
      <isNotNull prepend="," property="singleSetStockAmount">
        single_set_stock_amount
      </isNotNull>
      <isNotNull prepend="," property="amount">
        amount
      </isNotNull>
      <isNotNull prepend="," property="price">
        price
      </isNotNull>
      <isNotNull prepend="," property="productUnit">
        product_unit
      </isNotNull>
      <isNotNull prepend="," property="rebate">
        rebate
      </isNotNull>
      <isNotNull prepend="," property="netPrice">
        net_price
      </isNotNull>
      <isNotNull prepend="," property="money">
        money
      </isNotNull>
      <isNotNull prepend="," property="taxNetPrice">
        tax_net_price
      </isNotNull>
      <isNotNull prepend="," property="taxMoney">
        tax_money
      </isNotNull>
      <isNotNull prepend="," property="priceChange">
        price_change
      </isNotNull>
      <isNotNull prepend="," property="deliveryDate">
        delivery_date
      </isNotNull>
      <isNotNull prepend="," property="workshop">
        workshop
      </isNotNull>
      <isNotNull prepend="," property="processCode">
        process_code
      </isNotNull>
      <isNotNull prepend="," property="reportCode">
        report_code
      </isNotNull>
      <isNotNull prepend="," property="toolCode">
        tool_code
      </isNotNull>
      <isNotNull prepend="," property="toolDescription">
        tool_description
      </isNotNull>
      <isNotNull prepend="," property="memo">
        memo
      </isNotNull>
      )
    </dynamic>
    values
    <dynamic prepend="(">
      <isNotNull prepend="," property="id">
        #id:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="quotationProjectSortId">
        #quotationProjectSortId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="quotationInforId">
        #quotationInforId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="toolsId">
        #toolsId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="parentToolsId">
        #parentToolsId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="leaf">
        #leaf:INTEGER#
      </isNotNull>
      <isNotNull prepend="," property="projectCode">
        #projectCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="serialNumber">
        #serialNumber:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="productBrand">
        #productBrand:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="productCode">
        #productCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="brandCode">
        #brandCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="productName">
        #productName:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="singleSetAssemblyAmount">
        #singleSetAssemblyAmount:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="singleSetStockAmount">
        #singleSetStockAmount:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="amount">
        #amount:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="price">
        #price:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="productUnit">
        #productUnit:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="rebate">
        #rebate:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="netPrice">
        #netPrice:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="money">
        #money:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="taxNetPrice">
        #taxNetPrice:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="taxMoney">
        #taxMoney:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="priceChange">
        #priceChange:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="deliveryDate">
        #deliveryDate:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="workshop">
        #workshop:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="processCode">
        #processCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="reportCode">
        #reportCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="toolCode">
        #toolCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="toolDescription">
        #toolDescription:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="memo">
        #memo:VARCHAR#
      </isNotNull>
      )
    </dynamic>
  </insert>
  <select id="ibatorgenerated_countByExample" parameterClass="com.tl.resource.dao.pojo.TQuotationProductDetailExample" resultClass="java.lang.Integer">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    select count(*) from t_quotation_product_detail
    <include refid="t_quotation_product_detail.ibatorgenerated_Example_Where_Clause" />
  </select>
  <update id="ibatorgenerated_updateByExampleSelective">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    update t_quotation_product_detail
    <dynamic prepend="set">
      <isNotNull prepend="," property="record.id">
        id = #record.id:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.quotationProjectSortId">
        quotation_project_sort_id = #record.quotationProjectSortId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.quotationInforId">
        quotation_infor_id = #record.quotationInforId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.toolsId">
        tools_id = #record.toolsId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.parentToolsId">
        parent_tools_id = #record.parentToolsId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.leaf">
        leaf = #record.leaf:INTEGER#
      </isNotNull>
      <isNotNull prepend="," property="record.projectCode">
        project_code = #record.projectCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.serialNumber">
        serial_number = #record.serialNumber:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="record.productBrand">
        product_brand = #record.productBrand:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.productCode">
        product_code = #record.productCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.brandCode">
        brand_code = #record.brandCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.productName">
        product_name = #record.productName:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.singleSetAssemblyAmount">
        single_set_assembly_amount = #record.singleSetAssemblyAmount:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="record.singleSetStockAmount">
        single_set_stock_amount = #record.singleSetStockAmount:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="record.amount">
        amount = #record.amount:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="record.price">
        price = #record.price:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="record.productUnit">
        product_unit = #record.productUnit:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.rebate">
        rebate = #record.rebate:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="record.netPrice">
        net_price = #record.netPrice:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="record.money">
        money = #record.money:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="record.taxNetPrice">
        tax_net_price = #record.taxNetPrice:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="record.taxMoney">
        tax_money = #record.taxMoney:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="record.priceChange">
        price_change = #record.priceChange:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="record.deliveryDate">
        delivery_date = #record.deliveryDate:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.workshop">
        workshop = #record.workshop:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.processCode">
        process_code = #record.processCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.reportCode">
        report_code = #record.reportCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.toolCode">
        tool_code = #record.toolCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.toolDescription">
        tool_description = #record.toolDescription:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="record.memo">
        memo = #record.memo:VARCHAR#
      </isNotNull>
    </dynamic>
    <isParameterPresent>
      <include refid="t_quotation_product_detail.ibatorgenerated_Example_Where_Clause" />
    </isParameterPresent>
  </update>
  <update id="ibatorgenerated_updateByExample">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    update t_quotation_product_detail
    set id = #record.id:VARCHAR#,
      quotation_project_sort_id = #record.quotationProjectSortId:VARCHAR#,
      quotation_infor_id = #record.quotationInforId:VARCHAR#,
      tools_id = #record.toolsId:VARCHAR#,
      parent_tools_id = #record.parentToolsId:VARCHAR#,
      leaf = #record.leaf:INTEGER#,
      project_code = #record.projectCode:VARCHAR#,
      serial_number = #record.serialNumber:DECIMAL#,
      product_brand = #record.productBrand:VARCHAR#,
      product_code = #record.productCode:VARCHAR#,
      brand_code = #record.brandCode:VARCHAR#,
      product_name = #record.productName:VARCHAR#,
      single_set_assembly_amount = #record.singleSetAssemblyAmount:DECIMAL#,
      single_set_stock_amount = #record.singleSetStockAmount:DECIMAL#,
      amount = #record.amount:DECIMAL#,
      price = #record.price:DECIMAL#,
      product_unit = #record.productUnit:VARCHAR#,
      rebate = #record.rebate:DECIMAL#,
      net_price = #record.netPrice:DECIMAL#,
      money = #record.money:DECIMAL#,
      tax_net_price = #record.taxNetPrice:DECIMAL#,
      tax_money = #record.taxMoney:DECIMAL#,
      price_change = #record.priceChange:DECIMAL#,
      delivery_date = #record.deliveryDate:VARCHAR#,
      workshop = #record.workshop:VARCHAR#,
      process_code = #record.processCode:VARCHAR#,
      report_code = #record.reportCode:VARCHAR#,
      tool_code = #record.toolCode:VARCHAR#,
      tool_description = #record.toolDescription:VARCHAR#,
      memo = #record.memo:VARCHAR#
    <isParameterPresent>
      <include refid="t_quotation_product_detail.ibatorgenerated_Example_Where_Clause" />
    </isParameterPresent>
  </update>
  <update id="ibatorgenerated_updateByPrimaryKeySelective" parameterClass="com.tl.resource.dao.pojo.TQuotationProductDetail">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    update t_quotation_product_detail
    <dynamic prepend="set">
      <isNotNull prepend="," property="quotationProjectSortId">
        quotation_project_sort_id = #quotationProjectSortId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="quotationInforId">
        quotation_infor_id = #quotationInforId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="toolsId">
        tools_id = #toolsId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="parentToolsId">
        parent_tools_id = #parentToolsId:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="leaf">
        leaf = #leaf:INTEGER#
      </isNotNull>
      <isNotNull prepend="," property="projectCode">
        project_code = #projectCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="serialNumber">
        serial_number = #serialNumber:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="productBrand">
        product_brand = #productBrand:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="productCode">
        product_code = #productCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="brandCode">
        brand_code = #brandCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="productName">
        product_name = #productName:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="singleSetAssemblyAmount">
        single_set_assembly_amount = #singleSetAssemblyAmount:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="singleSetStockAmount">
        single_set_stock_amount = #singleSetStockAmount:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="amount">
        amount = #amount:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="price">
        price = #price:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="productUnit">
        product_unit = #productUnit:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="rebate">
        rebate = #rebate:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="netPrice">
        net_price = #netPrice:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="money">
        money = #money:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="taxNetPrice">
        tax_net_price = #taxNetPrice:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="taxMoney">
        tax_money = #taxMoney:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="priceChange">
        price_change = #priceChange:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="deliveryDate">
        delivery_date = #deliveryDate:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="workshop">
        workshop = #workshop:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="processCode">
        process_code = #processCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="reportCode">
        report_code = #reportCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="toolCode">
        tool_code = #toolCode:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="toolDescription">
        tool_description = #toolDescription:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="memo">
        memo = #memo:VARCHAR#
      </isNotNull>
    </dynamic>
    where id = #id:VARCHAR#
  </update>
  <update id="ibatorgenerated_updateByPrimaryKey" parameterClass="com.tl.resource.dao.pojo.TQuotationProductDetail">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    update t_quotation_product_detail
    set quotation_project_sort_id = #quotationProjectSortId:VARCHAR#,
      quotation_infor_id = #quotationInforId:VARCHAR#,
      tools_id = #toolsId:VARCHAR#,
      parent_tools_id = #parentToolsId:VARCHAR#,
      leaf = #leaf:INTEGER#,
      project_code = #projectCode:VARCHAR#,
      serial_number = #serialNumber:DECIMAL#,
      product_brand = #productBrand:VARCHAR#,
      product_code = #productCode:VARCHAR#,
      brand_code = #brandCode:VARCHAR#,
      product_name = #productName:VARCHAR#,
      single_set_assembly_amount = #singleSetAssemblyAmount:DECIMAL#,
      single_set_stock_amount = #singleSetStockAmount:DECIMAL#,
      amount = #amount:DECIMAL#,
      price = #price:DECIMAL#,
      product_unit = #productUnit:VARCHAR#,
      rebate = #rebate:DECIMAL#,
      net_price = #netPrice:DECIMAL#,
      money = #money:DECIMAL#,
      tax_net_price = #taxNetPrice:DECIMAL#,
      tax_money = #taxMoney:DECIMAL#,
      price_change = #priceChange:DECIMAL#,
      delivery_date = #deliveryDate:VARCHAR#,
      workshop = #workshop:VARCHAR#,
      process_code = #processCode:VARCHAR#,
      report_code = #reportCode:VARCHAR#,
      tool_code = #toolCode:VARCHAR#,
      tool_description = #toolDescription:VARCHAR#,
      memo = #memo:VARCHAR#
    where id = #id:VARCHAR#
  </update>
  
  <!-- 根据报价单ID查找报价详细(标准品) -->
  <select id="getQuotationDetailByInforId" parameterClass="java.util.Map" resultClass="java.util.List" resultMap="ibatorgenerated_BaseResultMap">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    select id, quotation_project_sort_id, quotation_infor_id, tools_id, parent_tools_id, leaf,
      project_code, serial_number, product_brand, product_code, brand_code, product_name,
      single_set_assembly_amount, single_set_stock_amount, amount, price, product_unit, rebate,
      net_price, money, tax_net_price, tax_money, price_change, delivery_date, workshop,
      process_code, report_code, tool_code, tool_description, memo
    from t_quotation_product_detail
    where quotation_infor_id = '$qId$'
    and parent_tools_id = 'root'
	and leaf = 1
	order by serial_number
		limit $startIndex$,$pageSize$
  </select>
   <!-- 根据报价单ID查找报价详细数量(标准品) -->
  <select id="getQuotationDetailCountByInforId" parameterClass="java.util.Map" resultClass="java.lang.Integer">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    select count(*) from t_quotation_product_detail
    where quotation_infor_id = '$qId$'
    and parent_tools_id = 'root'
	and leaf = 1
  </select>
   <!-- 根据报价单和供应商查找报价单详细(标准品) -->
  <select id="getQuotationDetailBySupplier" parameterClass="java.util.Map" resultClass="java.util.List" resultMap="orderDetailResultMap">
    select ss.history_price * (1-((ifnull(re.rebate,0)/100))) price,ss.id as contract_product_detail_id,
	ss.brand_code,ss.tools_id,ss.parent_tools_id,ss.leaf,ss.product_name,ss.amount as contract_amount,  
	ss.order_amount,ss.remain_amount,ss.product_unit,0 as product_money,ss.product_brand,ss.product_code,  
	ss.serial_number,ss.project_code,'' as delivery_date,0 as file_count,ss.pro_sort_name
	from 
	(
		select i.*,ifnull(his.history_price,0) history_price from 
		( 
		select * from (
		select 
			nn.id, nn.quotation_project_sort_id, nn.quotation_infor_id, nn.tools_id, nn.parent_tools_id,nn.leaf,
      nn.project_code, nn.serial_number, nn.product_brand, nn.product_code, nn.brand_code, nn.product_name,
      nn.single_set_assembly_amount, nn.single_set_stock_amount, nn.amount, nn.price, nn.product_unit, nn.rebate,
      nn.net_price, nn.money, nn.tax_net_price, nn.tax_money, nn.price_change, nn.delivery_date, nn.workshop,
      nn.process_code, nn.report_code, nn.tool_code, nn.tool_description, nn.memo,
			pd.order_price_run_date,nc.product_sort_id product_sort_id,
		(nn.amount-IFNULL((SELECT SUM(o.order_amount) FROM t_order_detail o WHERE o.contract_product_detail_id = nn.id),0)-IFNULL((SELECT SUM(s.amount) FROM t_out_stock_infor oi,t_out_stock_detail s WHERE oi.id = s.out_stock_infor_id AND oi.out_stock_type IN (5,6) AND oi.status != 2 AND  s.contract_product_detail_id = nn.id),0)) AS remain_amount,
	0 order_amount,(select pro_sort_name from t_quotation_project_sort_infor where id = nn.quotation_project_sort_id) as pro_sort_name
			from 
				t_quotation_product_detail nn,
				t_product_tools_infor nc,
				t_suppliers_brand b,
				t_product_brand pd
				where b.t_suppliers_id = #supplierId:VARCHAR#
			    and nn.quotation_infor_id = (select id from t_quotation_infor where quotation_code = #quotationCode:VARCHAR#)
				and nn.parent_tools_id = 'root'      
				and nn.leaf = 1   
				and nn.product_brand = b.brand
				and nn.tools_id = nc.id
				and nc.product_brand = pd.name 
				<isNotEmpty property="productBrand" prepend="and">
			      <![CDATA[ nn.product_brand like '%$productBrand$%' ]]>
			    </isNotEmpty>
				<isNotEmpty property="brandCode" prepend="and">
			      <![CDATA[ nn.brand_code like '%$brandCode$%' ]]>
			    </isNotEmpty>
			    <isNotEmpty property="productName" prepend="and">
			      <![CDATA[ nn.product_name like '%$productName$%' ]]>
			    </isNotEmpty>
			    <isNotEmpty property="contractProjectSortId" prepend="and">
			      <![CDATA[ nn.quotation_project_sort_id = #contractProjectSortId# ]]>
			    </isNotEmpty>
			) m
			where	m.remain_amount > 0
			 <isNotNull prepend="" property="startIndex">
			         limit #startIndex:INTEGER#,#pageSize:INTEGER#
			  </isNotNull>
		) i left join 
		t_sales_price_history his
		on i.tools_id = his.product_tool_infor_id
		and i.order_price_run_date = his.sale_price_date
		) ss left join 
		t_rebate re 
		on re.product_sort_id = ss.product_sort_id
		and re.customers_degree_id = 'xxx'
		order by quotation_project_sort_id,serial_number
  </select>
     <!-- 根据报价单和供应商查找报价单详细数量(标准品) -->
  <select id="getQuotationDetailCountBySupplier" parameterClass="java.util.Map" resultClass="java.lang.Integer">
     select count(*) from 
	(
		select i.*,ifnull(his.history_price,0) history_price from 
		( 
		select * from (
		select 
			nn.*,pd.order_price_run_date,nc.product_sort_id product_sort_id,
		(nn.amount-ifnull((select sum(o.order_amount) from t_order_detail o where o.contract_product_detail_id = nn.id),0)-ifnull((select sum(s.amount) from t_out_stock_detail s where s.contract_product_detail_id = nn.id),0)) as remain_amount,
	0 order_amount,(select pro_sort_name from t_quotation_project_sort_infor where id = nn.quotation_project_sort_id) as pro_sort_name
			from 
				t_quotation_product_detail nn,
				t_product_tools_infor nc,
				t_suppliers_brand b,
				t_product_brand pd
				where b.t_suppliers_id = #supplierId:VARCHAR#
				and nn.quotation_infor_id = (select id from t_quotation_infor where quotation_code = #quotationCode:VARCHAR# )
				and nn.parent_tools_id = 'root'   
				and nn.leaf = 1         
				and nn.product_brand = b.brand
				and nn.tools_id = nc.id
				and nc.product_brand = pd.name 
				<isNotEmpty property="productBrand" prepend="and">
			      <![CDATA[ nn.product_brand like '%$productBrand$%' ]]>
			    </isNotEmpty>
				<isNotEmpty property="brandCode" prepend="and">
			      <![CDATA[ nn.brand_code like '%$brandCode$%' ]]>
			    </isNotEmpty>
			    <isNotEmpty property="productName" prepend="and">
			      <![CDATA[ nn.product_name like '%$productName$%' ]]>
			    </isNotEmpty>
			     <isNotEmpty property="contractProjectSortId" prepend="and">
			      <![CDATA[ nn.quotation_project_sort_id = #contractProjectSortId# ]]>
			    </isNotEmpty>
			) m
			where	m.remain_amount > 0
		) i left join 
		t_sales_price_history his
		on i.tools_id = his.product_tool_infor_id
		and i.order_price_run_date = his.sale_price_date
		) ss left join 
		t_rebate re 
		on re.product_sort_id = ss.product_sort_id
		and re.customers_degree_id = 'xxx'
  </select>
  
  <!-- 根据报价单ID查找报价详细(非标品) -->
  <select id="getQuoDetailById" parameterClass="java.util.Map" resultClass="java.util.List" resultMap="resultChild">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    select id, quotation_project_sort_id, quotation_infor_id, tools_id, parent_tools_id, leaf,
      project_code, serial_number, product_brand, product_code, brand_code, product_name,
      single_set_assembly_amount, single_set_stock_amount, amount, price, product_unit, rebate,
      net_price, money, tax_net_price, tax_money, price_change, delivery_date, workshop,
      process_code, report_code, tool_code, tool_description, memo,0 remain_amount,
	0 as order_amount,'' as pro_sort_name,
		(select ifnull(count(*),0) from t_accessories where business_id = d.tools_id and business_type = 1) as file_count
    from t_quotation_product_detail d
    where quotation_infor_id = '$qId$'
    	and parent_tools_id = 'root'
		and leaf = 0
		order by serial_number
		limit $startIndex$,$pageSize$
  </select>
   <!-- 根据报价单ID查找报价详细数量(非标品) -->
  <select id="getQuoDetailCountById" parameterClass="java.util.Map" resultClass="java.lang.Integer">
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Wed Oct 14 14:13:27 CST 2009.
    -->
    select count(*) from t_quotation_product_detail
    where quotation_infor_id = '$qId$'
   	and parent_tools_id = 'root'
	and leaf = 0
  </select>
  
     <!-- 根据报价单和供应商查找报价单详细(非标品) -->
  <select id="getQuoDetailBySupplier" parameterClass="java.util.Map" resultClass="java.util.List" resultMap="childrenPartResult">
    select ss.history_price * (1-((ifnull(re.rebate,0)/100))) price,
    ss.id as contract_product_detail_id,
	ss.brand_code,ss.tools_id,ss.parent_tools_id,ss.leaf,ss.product_name,ss.amount as contract_amount,  
	ss.order_amount,ss.remain_amount,ss.product_unit,0 as product_money,ss.product_brand,ss.product_code,  
	ss.serial_number,'' as delivery_date,ss.file_count,ss.pro_sort_name
	from 
	(
		select i.*,ifnull(his.history_price,0) history_price from 
		( 
		select * from (
		select 
			nn.id, nn.quotation_project_sort_id, nn.quotation_infor_id, nn.tools_id, nn.parent_tools_id,nn.leaf,
      nn.project_code, nn.serial_number, nn.product_brand, nn.product_code, nn.brand_code, nn.product_name,
      nn.single_set_assembly_amount, nn.single_set_stock_amount, nn.amount, nn.price, nn.product_unit, nn.rebate,
      nn.net_price, nn.money, nn.tax_net_price, nn.tax_money, nn.price_change, nn.delivery_date, nn.workshop,
      nn.process_code, nn.report_code, nn.tool_code, nn.tool_description, nn.memo,
			pd.order_price_run_date,nc.product_sort_id product_sort_id,
		(nn.amount-ifnull((select sum(o.order_amount) from t_order_detail o where o.contract_product_detail_id = nn.id),0)-ifnull((select sum(s.amount) from t_out_stock_detail s where s.contract_product_detail_id = nn.id),0)) as remain_amount,
	0 as order_amount,(select pro_sort_name from t_quotation_project_sort_infor where id = nn.quotation_project_sort_id) as pro_sort_name,
		(select ifnull(count(*),0) from t_accessories where business_id = nn.tools_id and business_type = 1) as file_count
			from 
				t_quotation_product_detail nn,
				t_product_tools_infor nc,
				t_suppliers_brand b,
				t_product_brand pd
				where b.t_suppliers_id = #supplierId:VARCHAR#
			    and nn.quotation_infor_id = (select id from t_quotation_infor where quotation_code = #quotationCode:VARCHAR#)
				and nn.parent_tools_id = 'root'      
				and nn.leaf = 0   
				and nn.product_brand = b.brand
				and nn.tools_id = nc.id
				and nc.product_brand = pd.name 
				<isNotEmpty property="productBrand" prepend="and">
			      <![CDATA[ nn.product_brand like '%$productBrand$%' ]]>
			    </isNotEmpty>
				<isNotEmpty property="brandCode" prepend="and">
			      <![CDATA[ nn.brand_code like '%$brandCode$%' ]]>
			    </isNotEmpty>
			    <isNotEmpty property="productName" prepend="and">
			      <![CDATA[ nn.product_name like '%$productName$%' ]]>
			    </isNotEmpty>
			    <isNotEmpty property="contractProjectSortId" prepend="and">
			      <![CDATA[ nn.quotation_project_sort_id = #contractProjectSortId# ]]>
			    </isNotEmpty>
			) m
			where	m.remain_amount > 0
			 <isNotNull prepend="" property="startIndex">
			         limit #startIndex:INTEGER#,#pageSize:INTEGER#
			  </isNotNull>
		) i left join 
		t_sales_price_history his
		on i.tools_id = his.product_tool_infor_id
		and i.order_price_run_date = his.sale_price_date
		) ss left join 
		t_rebate re 
		on re.product_sort_id = ss.product_sort_id
		and re.customers_degree_id = 'xxx'
		order by serial_number
  </select>
     <!-- 根据报价单和供应商查找报价单详细数量(非标品) -->
  <select id="getQuoDetailCountBySupplier" parameterClass="java.util.Map" resultClass="java.lang.Integer">
     select count(*) from 
	(
		select i.*,ifnull(his.history_price,0) history_price from 
		( 
		select * from (
		select 
			nn.*,pd.order_price_run_date,nc.product_sort_id product_sort_id,
		(nn.amount-ifnull((select sum(o.order_amount) from t_order_detail o where o.contract_product_detail_id = nn.id),0)-ifnull((select sum(s.amount) from t_out_stock_detail s where s.contract_product_detail_id = nn.id),0)) as remain_amount,
	0 order_amount,(select pro_sort_name from t_quotation_project_sort_infor where id = nn.quotation_project_sort_id) as pro_sort_name
			from 
				t_quotation_product_detail nn,
				t_product_tools_infor nc,
				t_suppliers_brand b,
				t_product_brand pd
				where b.t_suppliers_id = #supplierId:VARCHAR#
				and nn.quotation_infor_id = (select id from t_quotation_infor where quotation_code = #quotationCode:VARCHAR# )
				and nn.parent_tools_id = 'root'   
				and nn.leaf = 0         
				and nn.product_brand = b.brand
				and nn.tools_id = nc.id
				and nc.product_brand = pd.name 
				<isNotEmpty property="productBrand" prepend="and">
			      <![CDATA[ nn.product_brand like '%$productBrand$%' ]]>
			    </isNotEmpty>
				<isNotEmpty property="brandCode" prepend="and">
			      <![CDATA[ nn.brand_code like '%$brandCode$%' ]]>
			    </isNotEmpty>
			    <isNotEmpty property="productName" prepend="and">
			      <![CDATA[ nn.product_name like '%$productName$%' ]]>
			    </isNotEmpty>
			     <isNotEmpty property="contractProjectSortId" prepend="and">
			      <![CDATA[ nn.quotation_project_sort_id = #contractProjectSortId# ]]>
			    </isNotEmpty>
			) m
			where	m.remain_amount > 0
		) i left join 
		t_sales_price_history his
		on i.tools_id = his.product_tool_infor_id
		and i.order_price_run_date = his.sale_price_date
		) ss left join 
		t_rebate re 
		on re.product_sort_id = ss.product_sort_id
		and re.customers_degree_id = 'xxx'
  </select>
</sqlMap>