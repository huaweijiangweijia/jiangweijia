<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="t_reserve_infor">
	<resultMap class="com.tl.resource.dao.pojo.TReserveInfor"
		id="ibatorgenerated_BaseResultMap">
		<!--
			WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
			This element was generated on Tue Nov 17 15:25:05 CST 2009.
		-->
		<result column="id" jdbcType="VARCHAR" property="id" />
		<result column="product_code" jdbcType="VARCHAR"
			property="productCode" />
		<result column="brand_code" jdbcType="VARCHAR"
			property="brandCode" />
		<result column="tools_id" jdbcType="VARCHAR" property="toolsId" />
		<result column="parent_tools_id" jdbcType="VARCHAR"
			property="parentToolsId" />
		<result column="leaf" jdbcType="INTEGER" property="leaf" />
		<result column="product_name" jdbcType="VARCHAR"
			property="productName" />
		<result column="product_unit" jdbcType="VARCHAR"
			property="productUnit" />
		<result column="reserve_code" jdbcType="VARCHAR"
			property="reserveCode" />
		<result column="amount" jdbcType="DECIMAL" property="amount" />
		<result column="price" jdbcType="DECIMAL" property="price" />
		<result column="product_sort" jdbcType="VARCHAR"
			property="productSort" />
		<result column="currency_name" jdbcType="VARCHAR"
			property="currencyName" />
		<result column="product_brand" jdbcType="VARCHAR"
			property="productBrand" />
		<result column="product_source" jdbcType="VARCHAR"
			property="productSource" />
		<result column="product_position" jdbcType="VARCHAR"
			property="productPosition" />
		<result column="slave_file" jdbcType="VARCHAR"
			property="slaveFile" />
		<result column="memo" jdbcType="VARCHAR" property="memo" />
	</resultMap>
	<resultMap id="dtoResult"
		class="com.tl.resource.business.dto.ReserveInforDto"
		extends="ibatorgenerated_BaseResultMap">
		<result column="dt_amount" jdbcType="DECIMAL"
			property="dtAmount" />
	</resultMap>
	<sql id="ibatorgenerated_Example_Where_Clause">
		<!--
			WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
			This element was generated on Tue Nov 17 15:25:05 CST 2009.
		-->
		<iterate conjunction="or" prepend="where"
			property="oredCriteria" removeFirstPrepend="iterate">
			<isEqual compareValue="true"
				property="oredCriteria[].valid">
				(
				<iterate conjunction="and" prepend="and"
					property="oredCriteria[].criteriaWithoutValue">
					$oredCriteria[].criteriaWithoutValue[]$
				</iterate>
				<iterate conjunction="and" prepend="and"
					property="oredCriteria[].criteriaWithSingleValue">
					$oredCriteria[].criteriaWithSingleValue[].condition$
					#oredCriteria[].criteriaWithSingleValue[].value#
				</iterate>
				<iterate conjunction="and" prepend="and"
					property="oredCriteria[].criteriaWithListValue">
					$oredCriteria[].criteriaWithListValue[].condition$
					<iterate close=")" conjunction="," open="("
						property="oredCriteria[].criteriaWithListValue[].values">
						#oredCriteria[].criteriaWithListValue[].values[]#
					</iterate>
				</iterate>
				<iterate conjunction="and" prepend="and"
					property="oredCriteria[].criteriaWithBetweenValue">
					$oredCriteria[].criteriaWithBetweenValue[].condition$
					#oredCriteria[].criteriaWithBetweenValue[].values[0]#
					and
					#oredCriteria[].criteriaWithBetweenValue[].values[1]#
				</iterate>
				)
			</isEqual>
		</iterate>
	</sql>

	<!-- 修改库存 -->
	<update id="updateAmount"
		parameterClass="com.tl.resource.dao.pojo.TReserveInfor">
		update t_reserve_infor set amount = #amount:DECIMAL# where id =
		#id:VARCHAR#
	</update>

	<!-- 删除库存帐页 -->
	<delete id="deleteAccounts" parameterClass="String">
		DELETE FROM t_accounts_infor WHERE invoice_id=#value#
	</delete>

	<!-- 根据货品编号获取库存信息(ftl 2009-11-17) -->
	<select id="getReserveInfoByProCode"
		parameterClass="java.lang.String"
		resultClass="com.tl.resource.dao.pojo.TReserveInfor"
		resultMap="ibatorgenerated_BaseResultMap">
		<![CDATA[
      select * from t_reserve_infor t where t.product_code=#value#
    ]]>
	</select>

	<select id="ibatorgenerated_selectByExample"
		parameterClass="com.tl.resource.dao.pojo.TReserveInforExample"
		resultMap="ibatorgenerated_BaseResultMap">
		<!--
			WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
			This element was generated on Tue Nov 17 15:25:05 CST 2009.
		-->
		select id, product_code, brand_code, tools_id, parent_tools_id,
		leaf, product_name, product_unit, reserve_code, amount, price,
		product_sort, currency_name, product_brand, product_source,
		product_position, slave_file, memo from t_reserve_infor
		<isParameterPresent>
			<include
				refid="t_reserve_infor.ibatorgenerated_Example_Where_Clause" />
			<isNotEmpty property="startIndex">
				limit $startIndex$,$pageSize$
			</isNotEmpty>
			<isNotNull property="orderByClause">
				order by $orderByClause$
			</isNotNull>
		</isParameterPresent>
	</select>
	<select id="ibatorgenerated_selectByPrimaryKey"
		parameterClass="com.tl.resource.dao.pojo.TReserveInfor"
		resultMap="ibatorgenerated_BaseResultMap">
		<!--
			WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
			This element was generated on Tue Nov 17 15:25:05 CST 2009.
		-->
		select id, product_code, brand_code, tools_id, parent_tools_id,
		leaf, product_name, product_unit, reserve_code, amount, price,
		product_sort, currency_name, product_brand, product_source,
		product_position, slave_file, memo from t_reserve_infor where id
		= #id:VARCHAR#
	</select>
	<delete id="ibatorgenerated_deleteByPrimaryKey"
		parameterClass="com.tl.resource.dao.pojo.TReserveInfor">
		<!--
			WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
			This element was generated on Tue Nov 17 15:25:05 CST 2009.
		-->
		delete from t_reserve_infor where id = #id:VARCHAR#
	</delete>
	<delete id="ibatorgenerated_deleteByExample"
		parameterClass="com.tl.resource.dao.pojo.TReserveInforExample">
		<!--
			WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
			This element was generated on Tue Nov 17 15:25:05 CST 2009.
		-->
		delete from t_reserve_infor
		<include
			refid="t_reserve_infor.ibatorgenerated_Example_Where_Clause" />
	</delete>
	<insert id="ibatorgenerated_insert"
		parameterClass="com.tl.resource.dao.pojo.TReserveInfor">
		<!--
			WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
			This element was generated on Tue Nov 17 15:25:05 CST 2009.
		-->
		insert into t_reserve_infor (id, product_code, brand_code,
		tools_id, parent_tools_id, leaf, product_name, product_unit,
		reserve_code, amount, price, product_sort, currency_name,
		product_brand, product_source, product_position, slave_file,
		memo) values (#id:VARCHAR#, #productCode:VARCHAR#,
		#brandCode:VARCHAR#, #toolsId:VARCHAR#, #parentToolsId:VARCHAR#,
		#leaf:INTEGER#, #productName:VARCHAR#, #productUnit:VARCHAR#,
		#reserveCode:VARCHAR#, #amount:DECIMAL#, #price:DECIMAL#,
		#productSort:VARCHAR#, #currencyName:VARCHAR#,
		#productBrand:VARCHAR#, #productSource:VARCHAR#,
		#productPosition:VARCHAR#, #slaveFile:VARCHAR#, #memo:VARCHAR#)
	</insert>
	<insert id="ibatorgenerated_insertSelective"
		parameterClass="com.tl.resource.dao.pojo.TReserveInfor">
		<!--
			WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
			This element was generated on Tue Nov 17 15:25:05 CST 2009.
		-->
		insert into t_reserve_infor
		<dynamic prepend="(">
			<isNotNull prepend="," property="id">id</isNotNull>
			<isNotNull prepend="," property="productCode">
				product_code
			</isNotNull>
			<isNotNull prepend="," property="brandCode">
				brand_code
			</isNotNull>
			<isNotNull prepend="," property="toolsId">
				tools_id
			</isNotNull>
			<isNotNull prepend="," property="parentToolsId">
				parent_tools_id
			</isNotNull>
			<isNotNull prepend="," property="leaf">leaf</isNotNull>
			<isNotNull prepend="," property="productName">
				product_name
			</isNotNull>
			<isNotNull prepend="," property="productUnit">
				product_unit
			</isNotNull>
			<isNotNull prepend="," property="reserveCode">
				reserve_code
			</isNotNull>
			<isNotNull prepend="," property="amount">amount</isNotNull>
			<isNotNull prepend="," property="price">price</isNotNull>
			<isNotNull prepend="," property="productSort">
				product_sort
			</isNotNull>
			<isNotNull prepend="," property="currencyName">
				currency_name
			</isNotNull>
			<isNotNull prepend="," property="productBrand">
				product_brand
			</isNotNull>
			<isNotNull prepend="," property="productSource">
				product_source
			</isNotNull>
			<isNotNull prepend="," property="productPosition">
				product_position
			</isNotNull>
			<isNotNull prepend="," property="slaveFile">
				slave_file
			</isNotNull>
			<isNotNull prepend="," property="memo">memo</isNotNull>
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotNull prepend="," property="id">
				#id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="productCode">
				#productCode:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="brandCode">
				#brandCode:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="toolsId">
				#toolsId:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="parentToolsId">
				#parentToolsId:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="leaf">
				#leaf:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="productName">
				#productName:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="productUnit">
				#productUnit:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="reserveCode">
				#reserveCode:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="amount">
				#amount:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="price">
				#price:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="productSort">
				#productSort:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="currencyName">
				#currencyName:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="productBrand">
				#productBrand:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="productSource">
				#productSource:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="productPosition">
				#productPosition:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="slaveFile">
				#slaveFile:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="memo">
				#memo:VARCHAR#
			</isNotNull>
			)
		</dynamic>
	</insert>
	<select id="ibatorgenerated_countByExample"
		parameterClass="com.tl.resource.dao.pojo.TReserveInforExample"
		resultClass="java.lang.Integer">
		<!--
			WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
			This element was generated on Tue Nov 17 15:25:05 CST 2009.
		-->
		select count(*) from t_reserve_infor
		<include
			refid="t_reserve_infor.ibatorgenerated_Example_Where_Clause" />
	</select>
	<update id="ibatorgenerated_updateByExampleSelective">
		<!--
			WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
			This element was generated on Tue Nov 17 15:25:05 CST 2009.
		-->
		update t_reserve_infor
		<dynamic prepend="set">
			<isNotNull prepend="," property="record.id">
				id = #record.id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="record.productCode">
				product_code = #record.productCode:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="record.brandCode">
				brand_code = #record.brandCode:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="record.toolsId">
				tools_id = #record.toolsId:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="record.parentToolsId">
				parent_tools_id = #record.parentToolsId:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="record.leaf">
				leaf = #record.leaf:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="record.productName">
				product_name = #record.productName:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="record.productUnit">
				product_unit = #record.productUnit:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="record.reserveCode">
				reserve_code = #record.reserveCode:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="record.amount">
				amount = #record.amount:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="record.price">
				price = #record.price:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="record.productSort">
				product_sort = #record.productSort:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="record.currencyName">
				currency_name = #record.currencyName:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="record.productBrand">
				product_brand = #record.productBrand:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="record.productSource">
				product_source = #record.productSource:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="record.productPosition">
				product_position = #record.productPosition:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="record.slaveFile">
				slave_file = #record.slaveFile:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="record.memo">
				memo = #record.memo:VARCHAR#
			</isNotNull>
		</dynamic>
		<isParameterPresent>
			<include
				refid="t_reserve_infor.ibatorgenerated_Example_Where_Clause" />
		</isParameterPresent>
	</update>
	<update id="ibatorgenerated_updateByExample">
		<!--
			WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
			This element was generated on Tue Nov 17 15:25:05 CST 2009.
		-->
		update t_reserve_infor set id = #record.id:VARCHAR#,
		product_code = #record.productCode:VARCHAR#, brand_code =
		#record.brandCode:VARCHAR#, tools_id = #record.toolsId:VARCHAR#,
		parent_tools_id = #record.parentToolsId:VARCHAR#, leaf =
		#record.leaf:INTEGER#, product_name =
		#record.productName:VARCHAR#, product_unit =
		#record.productUnit:VARCHAR#, reserve_code =
		#record.reserveCode:VARCHAR#, amount = #record.amount:DECIMAL#,
		price = #record.price:DECIMAL#, product_sort =
		#record.productSort:VARCHAR#, currency_name =
		#record.currencyName:VARCHAR#, product_brand =
		#record.productBrand:VARCHAR#, product_source =
		#record.productSource:VARCHAR#, product_position =
		#record.productPosition:VARCHAR#, slave_file =
		#record.slaveFile:VARCHAR#, memo = #record.memo:VARCHAR#
		<isParameterPresent>
			<include
				refid="t_reserve_infor.ibatorgenerated_Example_Where_Clause" />
		</isParameterPresent>
	</update>
	<update id="ibatorgenerated_updateByPrimaryKeySelective"
		parameterClass="com.tl.resource.dao.pojo.TReserveInfor">
		<!--
			WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
			This element was generated on Tue Nov 17 15:25:05 CST 2009.
		-->
		update t_reserve_infor
		<dynamic prepend="set">
			<isNotNull prepend="," property="productCode">
				product_code = #productCode:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="brandCode">
				brand_code = #brandCode:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="toolsId">
				tools_id = #toolsId:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="parentToolsId">
				parent_tools_id = #parentToolsId:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="leaf">
				leaf = #leaf:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="productName">
				product_name = #productName:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="productUnit">
				product_unit = #productUnit:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="reserveCode">
				reserve_code = #reserveCode:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="amount">
				amount = #amount:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="price">
				price = #price:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="productSort">
				product_sort = #productSort:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="currencyName">
				currency_name = #currencyName:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="productBrand">
				product_brand = #productBrand:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="productSource">
				product_source = #productSource:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="productPosition">
				product_position = #productPosition:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="slaveFile">
				slave_file = #slaveFile:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="memo">
				memo = #memo:VARCHAR#
			</isNotNull>
		</dynamic>
		where id = #id:VARCHAR#
	</update>
	<update id="ibatorgenerated_updateByPrimaryKey"
		parameterClass="com.tl.resource.dao.pojo.TReserveInfor">
		<!--
			WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
			This element was generated on Tue Nov 17 15:25:05 CST 2009.
		-->
		update t_reserve_infor set product_code = #productCode:VARCHAR#,
		brand_code = #brandCode:VARCHAR#, tools_id = #toolsId:VARCHAR#,
		parent_tools_id = #parentToolsId:VARCHAR#, leaf =
		#leaf:INTEGER#, product_name = #productName:VARCHAR#,
		product_unit = #productUnit:VARCHAR#, reserve_code =
		#reserveCode:VARCHAR#, amount = #amount:DECIMAL#, price =
		#price:DECIMAL#, product_sort = #productSort:VARCHAR#,
		currency_name = #currencyName:VARCHAR#, product_brand =
		#productBrand:VARCHAR#, product_source =
		#productSource:VARCHAR#, product_position =
		#productPosition:VARCHAR#, slave_file = #slaveFile:VARCHAR#,
		memo = #memo:VARCHAR# where id = #id:VARCHAR#
	</update>
	<update id="updateReserveAmount"
		parameterClass="com.tl.resource.dao.pojo.TReserveInfor">
		update t_reserve_infor i set i.amount = i.amount -
		#amount:DECIMAL# where i.id = #id:VARCHAR# and i.amount -
		#amount:DECIMAL# >= 0
	</update>

	<!-- 根据条件获取库存信息总数 -->
	<select id="getReserveTotal" parameterClass="java.util.Map"
		resultClass="java.lang.Integer">
		select count(*) FROM t_product_tools_infor a
		<dynamic prepend="where">
			<isNotEmpty prepend="and" property="productName">
				a.product_name like '%$productName$%'
			</isNotEmpty>
			<isNotEmpty prepend="and" property="productCode">
				a.product_code like '%$productCode$%'
			</isNotEmpty>
			<isNotEmpty prepend="and" property="productSort">
				a.product_sort like '%$productSort$%'
			</isNotEmpty>
			<isNotEmpty prepend="and" property="brandCode">
				a.brand_code like '%$brandCode$%'
			</isNotEmpty>
			<isNotEmpty prepend="and" property="productBrand">
				a.product_brand like '%$productBrand$%'
			</isNotEmpty>
			<isNotEmpty prepend="and" property="productSource">
				a.product_source like '%$productSource$%'
			</isNotEmpty>
		</dynamic>
	</select>

	<select id="getReserveTotalPrice" parameterClass="java.util.Map"
		resultClass="java.lang.Double">
		<![CDATA[
   	 SELECT SUM(iii.amount * IFNULL(sph.history_price,0)) AS total_price FROM (SELECT re.*FROM 
 (      SELECT b.id,c.id tid,c.product_code, c.brand_code ,c.leaf,c.product_name,c.product_unit,     
       c.product_sort,c.product_brand,c.product_source,CASE WHEN b.amount IS NULL THEN 0 ELSE b.amount END AS amount,b.product_position,b.slave_file,b.memo,b.reserve_code,        
    b.tools_id, b.parent_tools_id,b.price, b.currency_name FROM(SELECT a.id, a.product_code, a.brand_code ,a.leaf,a.product_name,a.product_unit,           a.product_sort_code AS product_sort,a.product_brand,a.product_source          
 FROM t_product_tools_infor a 
       ]]>
		<dynamic prepend="where">
			<isNotEmpty prepend="and" property="productName">
				a.product_name like '%$productName$%'
			</isNotEmpty>
			<isNotEmpty prepend="and" property="productCode">
				a.product_code like '%$productCode$%'
			</isNotEmpty>
			<isNotEmpty prepend="and" property="productSort">
				a.product_sort like '%$productSort$%'
			</isNotEmpty>
			<isNotEmpty prepend="and" property="brandCode">
				a.brand_code like '%$brandCode$%'
			</isNotEmpty>
			<isNotEmpty prepend="and" property="productBrand">
				a.product_brand like '%$productBrand$%'
			</isNotEmpty>
			<isNotEmpty prepend="and" property="productSource">
				a.product_source like '%$productSource$%'
			</isNotEmpty>
		</dynamic>
		<isNotEmpty property="sort">
			<![CDATA[
	          order by $sort$ $dir$
	        ]]>
		</isNotEmpty>
		<![CDATA[
         )c
		LEFT JOIN t_reserve_infor b ON c.id = b.tools_id
		) re LEFT JOIN (
			SELECT aa.product_code,aa.amount - IFNULL(bb.amount,0) amount FROM (
				SELECT osd.product_code,SUM(osd.amount) amount
				FROM t_out_stock_infor osi,t_out_stock_detail osd 
				WHERE osi.id = osd.out_stock_infor_id
				AND osi.status = 1
				AND out_stock_type IN (1,2,4,5,6,7)
				GROUP BY product_code
			) aa LEFT JOIN 
			(
				SELECT dd.product_code,SUM(dd.amount) amount
				FROM t_delivery_infor di,t_delivery_detail dd
				WHERE di.id = dd.delivery_infor_id
				AND di.status = 2
				GROUP BY product_code
			) bb
			ON aa.product_code = bb.product_code
		) dtkc ON re.product_code = dtkc.product_code) iii 
 	 LEFT JOIN ( SELECT MAX(t.sale_price_date) AS sale_price_date, t.product_brand     
  			 FROM t_sales_price_history t        
  			 WHERE t.sale_price_date <= (SELECT CURDATE())  AND t.product_brand IS NOT NULL     
        	GROUP BY t.product_brand ORDER BY t.sale_price_date DESC     ) d  
		ON  iii.product_brand=d.product_brand                 
     LEFT JOIN  t_sales_price_history sph       
      	ON iii.tid = sph.product_tool_infor_id   
        AND sph.sale_price_date = d.sale_price_date  
    ]]>
	</select>

	<!-- 根据分页参数获取信息 -->
	<select id="getReserveByPage" parameterClass="java.util.Map"
		resultMap="dtoResult">
		<![CDATA[
   	 SELECT re.*,IFNULL(dtkc.amount,0) dt_amount FROM (
   	 SELECT b.id, c.product_code, c.brand_code ,c.leaf,c.product_name,c.product_unit,          
c.product_sort,c.product_brand,c.product_source,CASE WHEN b.amount IS NULL THEN 0 ELSE b.amount END AS amount,b.product_position,b.slave_file,b.memo,b.reserve_code,          
b.tools_id, b.parent_tools_id,b.price, b.currency_name FROM(SELECT a.id, a.product_code, a.brand_code ,a.leaf,a.product_name,a.product_unit,          
a.product_sort_code AS product_sort,a.product_brand,a.product_source          
FROM t_product_tools_infor a    
       ]]>
		<dynamic prepend="where">
			<isNotEmpty prepend="and" property="productName">
				a.product_name like '%$productName$%'
			</isNotEmpty>
			<isNotEmpty prepend="and" property="productCode">
				a.product_code like '%$productCode$%'
			</isNotEmpty>
			<isNotEmpty prepend="and" property="productSort">
				a.product_sort like '%$productSort$%'
			</isNotEmpty>
			<isNotEmpty prepend="and" property="brandCode">
				a.brand_code like '%$brandCode$%'
			</isNotEmpty>
			<isNotEmpty prepend="and" property="productBrand">
				a.product_brand like '%$productBrand$%'
			</isNotEmpty>
			<isNotEmpty prepend="and" property="productSource">
				a.product_source like '%$productSource$%'
			</isNotEmpty>
		</dynamic>
		<isNotEmpty property="sort">
			<![CDATA[
	          order by $sort$ $dir$
	        ]]>
		</isNotEmpty>
		<![CDATA[
        limit #start#, #limit# )c
		LEFT JOIN t_reserve_infor b ON c.id = b.tools_id
		) re LEFT JOIN (
			SELECT aa.product_code,aa.amount - IFNULL(bb.amount,0) amount FROM (
				SELECT osd.product_code,SUM(osd.amount) amount
				FROM t_out_stock_infor osi,t_out_stock_detail osd 
				WHERE osi.id = osd.out_stock_infor_id
				AND osi.status = 1
				AND out_stock_type IN (1,2,4,5,6,7)
				GROUP BY product_code
			) aa LEFT JOIN 
			(
				SELECT dd.product_code,SUM(dd.amount) amount
				FROM t_delivery_infor di,t_delivery_detail dd
				WHERE di.id = dd.delivery_infor_id
				AND di.status = 2
				GROUP BY product_code
			) bb
			ON aa.product_code = bb.product_code
		) dtkc ON re.product_code = dtkc.product_code 
    ]]>
	</select>
	<select id="getDtReserveInforsByProductCode"
		parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT aa.contract_code,(aa.amount - IFNULL(bb.amount,0)) amount
		FROM ( select ttt.contract_code,sum(ttt.amount) amount from (
		SELECT CASE WHEN osi.contract_code = '' THEN osi.quotation_code
		WHEN osi.contract_code IS NULL THEN osi.quotation_code ELSE
		osi.contract_code END contract_code, osd.amount amount FROM
		t_out_stock_infor osi,t_out_stock_detail osd WHERE osi.id =
		osd.out_stock_infor_id AND osi.status = 1 AND out_stock_type IN
		(1,2,4,5,6,7) AND osd.product_code = #productCode# ) ttt GROUP
		BY ttt.contract_code ) aa LEFT JOIN ( select
		t2.contract_code,sum(t2.amount) amount from ( SELECT CASE WHEN
		di.contract_code = '' THEN di.quotation_code WHEN
		di.contract_code IS NULL THEN di.quotation_code ELSE
		di.contract_code END contract_code, dd.amount amount FROM
		t_delivery_infor di,t_delivery_detail dd WHERE di.id =
		dd.delivery_infor_id AND di.status = 2 AND dd.product_code =
		#productCode# ) t2 GROUP BY t2.contract_code ) bb ON
		aa.contract_code = bb.contract_code WHERE aa.amount -
		IFNULL(bb.amount,0) > 0 ORDER BY contract_code
	</select>
</sqlMap>